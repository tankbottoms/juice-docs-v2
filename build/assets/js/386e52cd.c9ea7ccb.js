"use strict";(self.webpackChunkjuice_docs_v_2=self.webpackChunkjuice_docs_v_2||[]).push([[98011],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>h});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},u=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),p=c(n),h=r,m=p["".concat(s,".").concat(h)]||p[h]||d[h]||i;return n?a.createElement(m,l(l({ref:t},u),{},{components:n})):a.createElement(m,l({ref:t},u))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,l=new Array(i);l[0]=p;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:r,l[1]=o;for(var c=2;c<i;c++)l[c]=n[c];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},85162:(e,t,n)=>{n.d(t,{Z:()=>l});var a=n(67294),r=n(86010);const i="tabItem_Ymn6";function l(e){let{children:t,hidden:n,className:l}=e;return a.createElement("div",{role:"tabpanel",className:(0,r.Z)(i,l),hidden:n},t)}},65488:(e,t,n)=>{n.d(t,{Z:()=>h});var a=n(87462),r=n(67294),i=n(86010),l=n(72389),o=n(67392),s=n(7094),c=n(12466);const u="tabList__CuJ",d="tabItem_LNqP";function p(e){var t,n;const{lazy:l,block:p,defaultValue:h,values:m,groupId:f,className:g}=e,b=r.Children.map(e.children,(e=>{if((0,r.isValidElement)(e)&&"value"in e.props)return e;throw new Error("Docusaurus error: Bad <Tabs> child <"+("string"==typeof e.type?e.type:e.type.name)+'>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.')})),y=null!=m?m:b.map((e=>{let{props:{value:t,label:n,attributes:a}}=e;return{value:t,label:n,attributes:a}})),k=(0,o.l)(y,((e,t)=>e.value===t.value));if(k.length>0)throw new Error('Docusaurus error: Duplicate values "'+k.map((e=>e.value)).join(", ")+'" found in <Tabs>. Every value needs to be unique.');const v=null===h?h:null!=(t=null!=h?h:null==(n=b.find((e=>e.props.default)))?void 0:n.props.value)?t:b[0].props.value;if(null!==v&&!y.some((e=>e.value===v)))throw new Error('Docusaurus error: The <Tabs> has a defaultValue "'+v+'" but none of its children has the corresponding value. Available values are: '+y.map((e=>e.value)).join(", ")+". If you intend to show no default tab, use defaultValue={null} instead.");const{tabGroupChoices:N,setTabGroupChoices:w}=(0,s.U)(),[_,C]=(0,r.useState)(v),T=[],{blockElementScrollPositionUntilNextRender:O}=(0,c.o5)();if(null!=f){const e=N[f];null!=e&&e!==_&&y.some((t=>t.value===e))&&C(e)}const E=e=>{const t=e.currentTarget,n=T.indexOf(t),a=y[n].value;a!==_&&(O(t),C(a),null!=f&&w(f,String(a)))},j=e=>{var t;let n=null;switch(e.key){case"ArrowRight":{var a;const t=T.indexOf(e.currentTarget)+1;n=null!=(a=T[t])?a:T[0];break}case"ArrowLeft":{var r;const t=T.indexOf(e.currentTarget)-1;n=null!=(r=T[t])?r:T[T.length-1];break}}null==(t=n)||t.focus()};return r.createElement("div",{className:(0,i.Z)("tabs-container",u)},r.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.Z)("tabs",{"tabs--block":p},g)},y.map((e=>{let{value:t,label:n,attributes:l}=e;return r.createElement("li",(0,a.Z)({role:"tab",tabIndex:_===t?0:-1,"aria-selected":_===t,key:t,ref:e=>T.push(e),onKeyDown:j,onFocus:E,onClick:E},l,{className:(0,i.Z)("tabs__item",d,null==l?void 0:l.className,{"tabs__item--active":_===t})}),null!=n?n:t)}))),l?(0,r.cloneElement)(b.filter((e=>e.props.value===_))[0],{className:"margin-top--md"}):r.createElement("div",{className:"margin-top--md"},b.map(((e,t)=>(0,r.cloneElement)(e,{key:t,hidden:e.props.value!==_})))))}function h(e){const t=(0,l.Z)();return r.createElement(p,(0,a.Z)({key:String(t)},e))}},30367:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>s,default:()=>h,frontMatter:()=>o,metadata:()=>c,toc:()=>d});var a=n(87462),r=(n(67294),n(3905)),i=n(65488),l=n(85162);const o={},s="_deriveWeightFrom",c={unversionedId:"dev/api/contracts/jbfundingcyclestore/read/-_deriveweightfrom",id:"dev/api/contracts/jbfundingcyclestore/read/-_deriveweightfrom",title:"_deriveWeightFrom",description:"Contract: JBFundingCycleStore\u200b",source:"@site/docs/dev/api/contracts/jbfundingcyclestore/read/-_deriveweightfrom.md",sourceDirName:"dev/api/contracts/jbfundingcyclestore/read",slug:"/dev/api/contracts/jbfundingcyclestore/read/-_deriveweightfrom",permalink:"/dev/api/contracts/jbfundingcyclestore/read/-_deriveweightfrom",draft:!1,editUrl:"https://github.com/jbx-protocol/juice-docs-v2/blob/main/docs/dev/api/contracts/jbfundingcyclestore/read/-_deriveweightfrom.md",tags:[],version:"current",frontMatter:{},sidebar:"dev",previous:{title:"_deriveStartFrom",permalink:"/dev/api/contracts/jbfundingcyclestore/read/-_derivestartfrom"},next:{title:"_eligibleOf",permalink:"/dev/api/contracts/jbfundingcyclestore/read/-_eligibleof"}},u={},d=[{value:"Definition",id:"definition",level:4},{value:"Body",id:"body",level:4}],p={toc:d};function h(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"_deriveweightfrom"},"_deriveWeightFrom"),(0,r.kt)("p",null,"Contract: ",(0,r.kt)("a",{parentName:"p",href:"/dev/api/contracts/jbfundingcyclestore/"},(0,r.kt)("inlineCode",{parentName:"a"},"JBFundingCycleStore")),"\u200b"),(0,r.kt)(i.Z,{mdxType:"Tabs"},(0,r.kt)(l.Z,{value:"Step by step",label:"Step by step",mdxType:"TabItem"},(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"The accumulated weight change since the specified funding cycle.")),(0,r.kt)("h4",{id:"definition"},"Definition"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"function _deriveWeightFrom(JBFundingCycle memory _baseFundingCycle, uint256 _start)\n  private\n  pure\n  returns (uint256 weight) { ... }\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Arguments:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"_baseFundingCycle")," is The ",(0,r.kt)("a",{parentName:"li",href:"/dev/api/data-structures/jbfundingcycle"},(0,r.kt)("inlineCode",{parentName:"a"},"JBFundingCycle"))," to base the calculation on."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"_start")," is the start time of the funding cycle to derive a number for."))),(0,r.kt)("li",{parentName:"ul"},"The view function is private to this contract."),(0,r.kt)("li",{parentName:"ul"},"The function does not alter state on the blockchain."),(0,r.kt)("li",{parentName:"ul"},"The function returns the derived weight, as a fixed point number with 18 decimals.")),(0,r.kt)("h4",{id:"body"},"Body"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"If the base funding cycle has no duration, the derived weight should be calculated from it no matter how much time has passed since it was active. The discount rate property in a ",(0,r.kt)("a",{parentName:"p",href:"/dev/api/data-structures/jbfundingcycle"},(0,r.kt)("inlineCode",{parentName:"a"},"JBFundingCycle"))," is out of ",(0,r.kt)("a",{parentName:"p",href:"/dev/api/libraries/jbconstants"},(0,r.kt)("inlineCode",{parentName:"a"},"JBConstants.MAX_DISCOUNT_RATE")),"."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"// A subsequent cycle to one with a duration of 0 should have the next possible weight.\nif (_baseFundingCycle.duration == 0)\n  return\n    PRBMath.mulDiv(\n      _baseFundingCycle.weight,\n      JBConstants.MAX_DISCOUNT_RATE - _baseFundingCycle.discountRate,\n      JBConstants.MAX_DISCOUNT_RATE\n    );\n")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("em",{parentName:"p"},"Library references:")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/hifi-finance/prb-math/blob/main/contracts/PRBMath.sol"},(0,r.kt)("inlineCode",{parentName:"a"},"PRBMath")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},".mulDiv(...)")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/dev/api/libraries/jbconstants"},(0,r.kt)("inlineCode",{parentName:"a"},"JBConstants")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},".MAX_DISCOUNT_RATE")))))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"The calculations that follow will progressively apply discount rates to the base funding cycle's weight to arrive at the correct weight to return."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"// The weight should be based off the base funding cycle's weight.\nweight = _baseFundingCycle.weight;\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"If the base doesn't have a discount rate, the original weight won't change and should be returned."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"// If the discount is 0, the weight doesn't change.\nif (_baseFundingCycle.discountRate == 0) return weight;\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Get a reference to how long after the base funding cycle's start the specified start time is."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"// The difference between the start of the base funding cycle and the proposed start.\nuint256 _startDistance = _start - _baseFundingCycle.start;\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Apply the base funding cycle's discount rate. Apply the rate as many times as there have been cycles within the start distance. No need to keep iterating if the weight has reached 0."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"// Apply the base funding cycle's discount rate for each cycle that has passed.\nuint256 _discountMultiple = _startDistance / _baseFundingCycle.duration;\n\nfor (uint256 i = 0; i < _discountMultiple; i++) {\n  // The number of times to apply the discount rate.\n  // Base the new weight on the specified funding cycle's weight.\n  weight = PRBMath.mulDiv(\n    weight,\n    JBConstants.MAX_DISCOUNT_RATE - _baseFundingCycle.discountRate,\n    JBConstants.MAX_DISCOUNT_RATE\n  );\n  // The calculation doesn't need to continue if the weight is 0.\n  if (weight == 0) break;\n}\n")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("em",{parentName:"p"},"Library references:")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/hifi-finance/prb-math/blob/main/contracts/PRBMath.sol"},(0,r.kt)("inlineCode",{parentName:"a"},"PRBMath")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},".mulDiv(...)")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/dev/api/libraries/jbconstants"},(0,r.kt)("inlineCode",{parentName:"a"},"JBConstants")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},".MAX_DISCOUNT_RATE")," "))))))),(0,r.kt)(l.Z,{value:"Code",label:"Code",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"/** \n  @notice \n  The accumulated weight change since the specified funding cycle.\n\n  @param _baseFundingCycle The funding cycle to base the calculation on.\n  @param _start The start time of the funding cycle to derive a number for.\n\n  @return weight The derived weight, as a fixed point number with 18 decimals.\n*/\nfunction _deriveWeightFrom(JBFundingCycle memory _baseFundingCycle, uint256 _start)\n  private\n  pure\n  returns (uint256 weight)\n{\n  // A subsequent cycle to one with a duration of 0 should have the next possible weight.\n  if (_baseFundingCycle.duration == 0)\n    return\n      PRBMath.mulDiv(\n        _baseFundingCycle.weight,\n        JBConstants.MAX_DISCOUNT_RATE - _baseFundingCycle.discountRate,\n        JBConstants.MAX_DISCOUNT_RATE\n      );\n\n  // The weight should be based off the base funding cycle's weight.\n  weight = _baseFundingCycle.weight;\n\n  // If the discount is 0, the weight doesn't change.\n  if (_baseFundingCycle.discountRate == 0) return weight;\n\n  // The difference between the start of the base funding cycle and the proposed start.\n  uint256 _startDistance = _start - _baseFundingCycle.start;\n\n  // Apply the base funding cycle's discount rate for each cycle that has passed.\n  uint256 _discountMultiple = _startDistance / _baseFundingCycle.duration;\n\n  for (uint256 i = 0; i < _discountMultiple; i++) {\n    // The number of times to apply the discount rate.\n    // Base the new weight on the specified funding cycle's weight.\n    weight = PRBMath.mulDiv(\n      weight,\n      JBConstants.MAX_DISCOUNT_RATE - _baseFundingCycle.discountRate,\n      JBConstants.MAX_DISCOUNT_RATE\n    );\n    // The calculation doesn't need to continue if the weight is 0.\n    if (weight == 0) break;\n  }\n}\n"))),(0,r.kt)(l.Z,{value:"Bug bounty",label:"Bug bounty",mdxType:"TabItem"},(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Category"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"),(0,r.kt)("th",{parentName:"tr",align:null},"Reward"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"Optimization")),(0,r.kt)("td",{parentName:"tr",align:null},"Help make this operation more efficient."),(0,r.kt)("td",{parentName:"tr",align:null},"0.5ETH")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"Low severity")),(0,r.kt)("td",{parentName:"tr",align:null},"Identify a vulnerability in this operation that could lead to an inconvenience for a user of the protocol or for a protocol developer."),(0,r.kt)("td",{parentName:"tr",align:null},"1ETH")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"High severity")),(0,r.kt)("td",{parentName:"tr",align:null},"Identify a vulnerability in this operation that could lead to data corruption or loss of funds."),(0,r.kt)("td",{parentName:"tr",align:null},"5+ETH")))))))}h.isMDXComponent=!0}}]);