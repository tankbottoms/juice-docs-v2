"use strict";(self.webpackChunkjuice_docs_v_2=self.webpackChunkjuice_docs_v_2||[]).push([[42332],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>u});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var m=a.createContext({}),p=function(e){var t=a.useContext(m),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(m.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},s=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,m=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),s=p(n),u=r,k=s["".concat(m,".").concat(u)]||s[u]||d[u]||o;return n?a.createElement(k,l(l({ref:t},c),{},{components:n})):a.createElement(k,l({ref:t},c))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,l=new Array(o);l[0]=s;var i={};for(var m in t)hasOwnProperty.call(t,m)&&(i[m]=t[m]);i.originalType=e,i.mdxType="string"==typeof e?e:r,l[1]=i;for(var p=2;p<o;p++)l[p]=n[p];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}s.displayName="MDXCreateElement"},85162:(e,t,n)=>{n.d(t,{Z:()=>l});var a=n(67294),r=n(86010);const o="tabItem_Ymn6";function l(e){let{children:t,hidden:n,className:l}=e;return a.createElement("div",{role:"tabpanel",className:(0,r.Z)(o,l),hidden:n},t)}},65488:(e,t,n)=>{n.d(t,{Z:()=>u});var a=n(87462),r=n(67294),o=n(86010),l=n(72389),i=n(67392),m=n(7094),p=n(12466);const c="tabList__CuJ",d="tabItem_LNqP";function s(e){var t,n;const{lazy:l,block:s,defaultValue:u,values:k,groupId:f,className:h}=e,N=r.Children.map(e.children,(e=>{if((0,r.isValidElement)(e)&&"value"in e.props)return e;throw new Error("Docusaurus error: Bad <Tabs> child <"+("string"==typeof e.type?e.type:e.type.name)+'>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.')})),g=null!=k?k:N.map((e=>{let{props:{value:t,label:n,attributes:a}}=e;return{value:t,label:n,attributes:a}})),y=(0,i.l)(g,((e,t)=>e.value===t.value));if(y.length>0)throw new Error('Docusaurus error: Duplicate values "'+y.map((e=>e.value)).join(", ")+'" found in <Tabs>. Every value needs to be unique.');const b=null===u?u:null!=(t=null!=u?u:null==(n=N.find((e=>e.props.default)))?void 0:n.props.value)?t:N[0].props.value;if(null!==b&&!g.some((e=>e.value===b)))throw new Error('Docusaurus error: The <Tabs> has a defaultValue "'+b+'" but none of its children has the corresponding value. Available values are: '+g.map((e=>e.value)).join(", ")+". If you intend to show no default tab, use defaultValue={null} instead.");const{tabGroupChoices:v,setTabGroupChoices:_}=(0,m.U)(),[T,C]=(0,r.useState)(b),w=[],{blockElementScrollPositionUntilNextRender:j}=(0,p.o5)();if(null!=f){const e=v[f];null!=e&&e!==T&&g.some((t=>t.value===e))&&C(e)}const I=e=>{const t=e.currentTarget,n=w.indexOf(t),a=g[n].value;a!==T&&(j(t),C(a),null!=f&&_(f,String(a)))},O=e=>{var t;let n=null;switch(e.key){case"ArrowRight":{var a;const t=w.indexOf(e.currentTarget)+1;n=null!=(a=w[t])?a:w[0];break}case"ArrowLeft":{var r;const t=w.indexOf(e.currentTarget)-1;n=null!=(r=w[t])?r:w[w.length-1];break}}null==(t=n)||t.focus()};return r.createElement("div",{className:(0,o.Z)("tabs-container",c)},r.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,o.Z)("tabs",{"tabs--block":s},h)},g.map((e=>{let{value:t,label:n,attributes:l}=e;return r.createElement("li",(0,a.Z)({role:"tab",tabIndex:T===t?0:-1,"aria-selected":T===t,key:t,ref:e=>w.push(e),onKeyDown:O,onFocus:I,onClick:I},l,{className:(0,o.Z)("tabs__item",d,null==l?void 0:l.className,{"tabs__item--active":T===t})}),null!=n?n:t)}))),l?(0,r.cloneElement)(N.filter((e=>e.props.value===T))[0],{className:"margin-top--md"}):r.createElement("div",{className:"margin-top--md"},N.map(((e,t)=>(0,r.cloneElement)(e,{key:t,hidden:e.props.value!==T})))))}function u(e){const t=(0,l.Z)();return r.createElement(s,(0,a.Z)({key:String(t)},e))}},22031:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>m,default:()=>u,frontMatter:()=>i,metadata:()=>p,toc:()=>d});var a=n(87462),r=(n(67294),n(3905)),o=n(65488),l=n(85162);const i={},m="recordRedemptionFor",p={unversionedId:"dev/api/contracts/jbsingletokenpaymentterminalstore/write/recordredemptionfor",id:"dev/api/contracts/jbsingletokenpaymentterminalstore/write/recordredemptionfor",title:"recordRedemptionFor",description:"Contract: JBSingleTokenPaymentTerminalStore\u200b\u200c",source:"@site/docs/dev/api/contracts/jbsingletokenpaymentterminalstore/write/recordredemptionfor.md",sourceDirName:"dev/api/contracts/jbsingletokenpaymentterminalstore/write",slug:"/dev/api/contracts/jbsingletokenpaymentterminalstore/write/recordredemptionfor",permalink:"/zh/dev/api/contracts/jbsingletokenpaymentterminalstore/write/recordredemptionfor",draft:!1,editUrl:"https://github.com/jbx-protocol/juice-docs-v2/blob/main/docs/dev/api/contracts/jbsingletokenpaymentterminalstore/write/recordredemptionfor.md",tags:[],version:"current",frontMatter:{},sidebar:"dev",previous:{title:"recordPaymentFrom",permalink:"/zh/dev/api/contracts/jbsingletokenpaymentterminalstore/write/recordpaymentfrom"},next:{title:"recordUsedAllowanceOf",permalink:"/zh/dev/api/contracts/jbsingletokenpaymentterminalstore/write/recordusedallowanceof"}},c={},d=[{value:"Definition",id:"definition",level:4},{value:"Body",id:"body",level:4}],s={toc:d};function u(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},s,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"recordredemptionfor"},"recordRedemptionFor"),(0,r.kt)("p",null,"Contract: ",(0,r.kt)("a",{parentName:"p",href:"/zh/dev/api/contracts/jbsingletokenpaymentterminalstore/"},(0,r.kt)("inlineCode",{parentName:"a"},"JBSingleTokenPaymentTerminalStore")),"\u200b\u200c"),(0,r.kt)("p",null,"Interface: ",(0,r.kt)("a",{parentName:"p",href:"/zh/dev/api/interfaces/ijbsingletokenpaymentterminalstore"},(0,r.kt)("inlineCode",{parentName:"a"},"IJBSingleTokenPaymentTerminalStore"))),(0,r.kt)(o.Z,{mdxType:"Tabs"},(0,r.kt)(l.Z,{value:"Step by step",label:"Step by step",mdxType:"TabItem"},(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Records newly redeemed tokens of a project.")),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"Redeems the project's tokens according to values provided by a configured data source. If no data source is configured, redeems tokens along a redemption bonding curve that is a function of the number of tokens being burned.")),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"The msg.sender must be an ",(0,r.kt)("a",{parentName:"em",href:"/zh/dev/api/interfaces/ijbpaymentterminal"},(0,r.kt)("inlineCode",{parentName:"a"},"IJBSingleTokenPaymentTerminal")),".")),(0,r.kt)("h4",{id:"definition"},"Definition"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"function recordRedemptionFor(\n  address _holder,\n  uint256 _projectId,\n  uint256 _tokenCount,\n  string memory _memo,\n  bytes memory _metadata\n)\n  external\n  override\n  nonReentrant\n  returns (\n    JBFundingCycle memory fundingCycle,\n    uint256 reclaimAmount,\n    IJBRedemptionDelegate delegate,\n    string memory memo\n  ) { ... }\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Arguments:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"_holder")," is the account that is having its tokens redeemed."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"_projectId")," is the ID of the project to which the tokens being redeemed belong."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"_tokenCount")," is the number of project tokens to redeem, as a fixed point number with 18 decimals."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"_memo")," is a memo to pass along to the emitted event."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"_metadata")," are bytes to send along to the data source, if one is provided."))),(0,r.kt)("li",{parentName:"ul"},"The resulting function overrides a function definition from the ",(0,r.kt)("a",{parentName:"li",href:"/zh/dev/api/interfaces/ijbsingletokenpaymentterminalstore"},(0,r.kt)("inlineCode",{parentName:"a"},"JBSingleTokenPaymentTerminalStore"))," interface."),(0,r.kt)("li",{parentName:"ul"},"The function returns:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"fundingCycle")," is the funding cycle during which the redemption was made."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"reclaimAmount")," is the amount of terminal tokens reclaimed, as a fixed point number with 18 decimals."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"delegate")," is a delegate contract to use for subsequent calls."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"memo")," is a memo that should be passed along to the emitted event.")))),(0,r.kt)("h4",{id:"body"},"Body"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Get a reference to the project's current funding cycle."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"// Get a reference to the project's current funding cycle.\nfundingCycle = fundingCycleStore.currentOf(_projectId);\n")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("em",{parentName:"p"},"External references:")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/zh/dev/api/contracts/jbfundingcyclestore/read/currentof"},(0,r.kt)("inlineCode",{parentName:"a"},"currentOf"))))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Make sure the project's funding cycle isn't configured to pause redemptions."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"// The current funding cycle must not be paused.\nif (fundingCycle.redeemPaused()) revert FUNDING_CYCLE_REDEEM_PAUSED();\n")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("em",{parentName:"p"},"Library references:")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/zh/dev/api/libraries/jbfundingcyclemetadataresolver"},(0,r.kt)("inlineCode",{parentName:"a"},"JBFundingCycleMetadataResolver")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},".redeemPaused(...)")))))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},'The following scoped block is a bit of a hack to prevent a "Stack too deep" error. '),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"// Scoped section prevents stack too deep. `_reclaimedTokenAmount`, `_currentOverflow`, and `_totalSupply` only used within scope.\n{ ... }\n")),(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Keep a reference to the reclaimed token amount, current overflow amount, and total supply variables to use outside of the subsequent scoped block"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"// Get a reference to the reclaimed token amount struct, the current overflow, and the total token supply.\nJBTokenAmount memory _reclaimedTokenAmount;\nuint256 _currentOverflow;\nuint256 _totalSupply;\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},'The following other scoped block uses the same hack to prevent a "Stack too deep" error. '),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"// Another scoped section prevents stack too deep. `_token`, `_decimals`, and `_currency` only used within scope.\n{ ... }\n")),(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Get a reference to the terminal's token, decimals, and currency."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"// Get a reference to the terminal's tokens.\naddress _token = IJBSingleTokenPaymentTerminal(msg.sender).token();\n\n// Get a reference to the terminal's decimals.\nuint256 _decimals = IJBSingleTokenPaymentTerminal(msg.sender).decimals();\n\n// Get areference to the terminal's currency.\nuint256 _currency = IJBSingleTokenPaymentTerminal(msg.sender).currency();\n")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("em",{parentName:"p"},"External references:")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/zh/dev/api/contracts/or-payment-terminals/or-abstract/jbsingletokenpaymentterminal/properties/token"},(0,r.kt)("inlineCode",{parentName:"a"},"token"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/zh/dev/api/contracts/or-payment-terminals/or-abstract/jbsingletokenpaymentterminal/properties/decimals"},(0,r.kt)("inlineCode",{parentName:"a"},"decimals"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/zh/dev/api/contracts/or-payment-terminals/or-abstract/jbsingletokenpaymentterminal/properties/currency"},(0,r.kt)("inlineCode",{parentName:"a"},"currency"))))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Get a reference to the amount of overflow the project has. Either the project's total overflow or the overflow local to the msg.sender's balance will be used depending on how the project's funding cycle is configured. "),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"// Get the amount of current overflow.\n// Use the local overflow if the funding cycle specifies that it should be used. Otherwise, use the project's total overflow across all of its terminals.\n_currentOverflow = fundingCycle.useTotalOverflowForRedemptions()\n  ? _currentTotalOverflowOf(_projectId, _decimals, _currency)\n  : _overflowDuring(\n    IJBSingleTokenPaymentTerminal(msg.sender),\n    _projectId,\n    fundingCycle,\n    _currency\n  );\n")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("em",{parentName:"p"},"Library references:")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/zh/dev/api/libraries/jbfundingcyclemetadataresolver"},(0,r.kt)("inlineCode",{parentName:"a"},"JBFundingCycleMetadataResolver")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},".useTotalOverflowForRedemptions(...)"))))),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("em",{parentName:"p"},"Internal references:")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/zh/dev/api/contracts/jbsingletokenpaymentterminalstore/read/-_currenttotaloverflowof"},(0,r.kt)("inlineCode",{parentName:"a"},"_currentTotalOverflowOf"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/zh/dev/api/contracts/jbsingletokenpaymentterminalstore/read/-_overflowduring"},(0,r.kt)("inlineCode",{parentName:"a"},"_overflowDuring"))))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Get a reference to the total outstanding supply of project tokens."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"// Get the number of outstanding tokens the project has.\n_totalSupply = IJBController(directory.controllerOf(_projectId))\n  .totalOutstandingTokensOf(_projectId, fundingCycle.reservedRate());\n")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("em",{parentName:"p"},"Library references:")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/zh/dev/api/libraries/jbfundingcyclemetadataresolver"},(0,r.kt)("inlineCode",{parentName:"a"},"JBFundingCycleMetadataResolver")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},".reservedRate(...)"))))),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("em",{parentName:"p"},"Internal references:")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/zh/dev/api/contracts/jbsingletokenpaymentterminalstore/properties/directory"},(0,r.kt)("inlineCode",{parentName:"a"},"directory")))),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("em",{parentName:"p"},"External references:")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/zh/dev/api/contracts/jbdirectory/properties/controllerof"},(0,r.kt)("inlineCode",{parentName:"a"},"controllerOf"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/zh/dev/api/contracts/or-controllers/jbcontroller/read/totaloutstandingtokensof"},(0,r.kt)("inlineCode",{parentName:"a"},"totalOutstandingTokensOf"))))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Make sure the provided token count is within the bounds of the total supply."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"// Can't redeem more tokens that is in the supply.\nif (_tokenCount > _totalSupply) revert INSUFFICIENT_TOKENS();\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Get a reference to the reclaimable overflow if there is overflow. "),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"if (_currentOverflow > 0)\n  // Calculate reclaim amount using the current overflow amount.\n  reclaimAmount = _reclaimableOverflowDuring(\n    _projectId,\n    fundingCycle,\n    _tokenCount,\n    _totalSupply,\n    _currentOverflow\n  );\n")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("em",{parentName:"p"},"Internal references:")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/zh/dev/api/contracts/jbsingletokenpaymentterminalstore/read/-_reclaimableoverflowduring"},(0,r.kt)("inlineCode",{parentName:"a"},"_reclaimableOverflowDuring"))))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Construct the reclaim amount struct."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"_reclaimedTokenAmount = JBTokenAmount(_token, reclaimAmount, _decimals, _currency);\n"))))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"If the project's current funding cycle is configured to use a data source when making redemptions, ask the data source for the parameters that should be used throughout the rest of the function given provided contextual values in a ",(0,r.kt)("a",{parentName:"p",href:"/zh/dev/api/data-structures/jbredeemparamsdata"},(0,r.kt)("inlineCode",{parentName:"a"},"JBRedeemParamsData"))," structure. Otherwise default parameters are used."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"// If the funding cycle has configured a data source, use it to derive a claim amount and memo.\nif (fundingCycle.useDataSourceForRedeem()) {\n  // Create the params that'll be sent to the data source.\n  JBRedeemParamsData memory _data = JBRedeemParamsData(\n    IJBSingleTokenPaymentTerminal(msg.sender),\n    _holder,\n    _projectId,\n    fundingCycle.configuration,\n    _tokenCount,\n    _totalSupply,\n    _currentOverflow,\n    _reclaimedTokenAmount,\n    fundingCycle.useTotalOverflowForRedemptions(),\n    fundingCycle.redemptionRate(),\n    fundingCycle.ballotRedemptionRate(),\n    _memo,\n    _metadata\n  );\n  (reclaimAmount, memo, delegate) = IJBFundingCycleDataSource(fundingCycle.dataSource())\n    .redeemParams(_data);\n} else {\n  memo = _memo;\n}\n")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("em",{parentName:"p"},"Library references:")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/zh/dev/api/libraries/jbfundingcyclemetadataresolver"},(0,r.kt)("inlineCode",{parentName:"a"},"JBFundingCycleMetadataResolver")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},".useDataSourceForRedeem(...)")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},".dataSource(...)")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},".redemptionRate(...)")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},".ballotRedemptionRate(...)")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},".useTotalOverflowForRedemptions(...)")))))))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Make sure the amount being claimed is within the bounds of the project's balance."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"// The amount being reclaimed must be within the project's balance.\nif (reclaimAmount > balanceOf[IJBSingleTokenPaymentTerminal(msg.sender)][_projectId])\n  revert INADEQUATE_PAYMENT_TERMINAL_STORE_BALANCE();\n")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("em",{parentName:"p"},"Internal references:")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/zh/dev/api/contracts/jbsingletokenpaymentterminalstore/properties/balanceof"},(0,r.kt)("inlineCode",{parentName:"a"},"balanceOf"))))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Decrement any claimed funds from the project's balance if needed."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"// Remove the reclaimed funds from the project's balance.\nif (reclaimAmount > 0)\n  balanceOf[IJBSingleTokenPaymentTerminal(msg.sender)][_projectId] =\n    balanceOf[IJBSingleTokenPaymentTerminal(msg.sender)][_projectId] -\n    reclaimAmount;\n")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("em",{parentName:"p"},"Internal references:")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/zh/dev/api/contracts/jbsingletokenpaymentterminalstore/properties/balanceof"},(0,r.kt)("inlineCode",{parentName:"a"},"balanceOf"))))))),(0,r.kt)(l.Z,{value:"Code",label:"Code",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"/**\n  @notice\n  Records newly redeemed tokens of a project.\n\n  @dev\n  Redeems the project's tokens according to values provided by a configured data source. If no data source is configured, redeems tokens along a redemption bonding curve that is a function of the number of tokens being burned.\n\n  @dev\n  The msg.sender must be an IJBSingleTokenPaymentTerminal. \n\n  @param _holder The account that is having its tokens redeemed.\n  @param _projectId The ID of the project to which the tokens being redeemed belong.\n  @param _tokenCount The number of project tokens to redeem, as a fixed point number with 18 decimals.\n  @param _memo A memo to pass along to the emitted event.\n  @param _metadata Bytes to send along to the data source, if one is provided.\n\n  @return fundingCycle The funding cycle during which the redemption was made.\n  @return reclaimAmount The amount of terminal tokens reclaimed, as a fixed point number with 18 decimals.\n  @return delegate A delegate contract to use for subsequent calls.\n  @return memo A memo that should be passed along to the emitted event.\n*/\nfunction recordRedemptionFor(\n  address _holder,\n  uint256 _projectId,\n  uint256 _tokenCount,\n  uint256 _balanceDecimals,\n  uint256 _balanceCurrency,\n  string memory _memo,\n  bytes memory _metadata\n)\n  external\n  override\n  nonReentrant\n  returns (\n    JBFundingCycle memory fundingCycle,\n    uint256 reclaimAmount,\n    IJBRedemptionDelegate delegate,\n    string memory memo\n  )\n{\n  // Get a reference to the project's current funding cycle.\n  fundingCycle = fundingCycleStore.currentOf(_projectId);\n\n  // The current funding cycle must not be paused.\n  if (fundingCycle.redeemPaused()) revert FUNDING_CYCLE_REDEEM_PAUSED();\n\n  // Scoped section prevents stack too deep. `_reclaimedTokenAmount`, `_currentOverflow`, and `_totalSupply` only used within scope.\n  {\n    // Get a reference to the reclaimed token amount struct, the current overflow, and the total token supply.\n    JBTokenAmount memory _reclaimedTokenAmount;\n    uint256 _currentOverflow;\n    uint256 _totalSupply;\n\n    // Another scoped section prevents stack too deep. `_token`, `_decimals`, and `_currency` only used within scope.\n    {\n      // Get a reference to the terminal's tokens.\n      address _token = IJBSingleTokenPaymentTerminal(msg.sender).token();\n\n      // Get a reference to the terminal's decimals.\n      uint256 _decimals = IJBSingleTokenPaymentTerminal(msg.sender).decimals();\n\n      // Get areference to the terminal's currency.\n      uint256 _currency = IJBSingleTokenPaymentTerminal(msg.sender).currency();\n\n      // Get the amount of current overflow.\n      // Use the local overflow if the funding cycle specifies that it should be used. Otherwise, use the project's total overflow across all of its terminals.\n      _currentOverflow = fundingCycle.useTotalOverflowForRedemptions()\n        ? _currentTotalOverflowOf(_projectId, _decimals, _currency)\n        : _overflowDuring(\n          IJBSingleTokenPaymentTerminal(msg.sender),\n          _projectId,\n          fundingCycle,\n          _currency\n        );\n\n      // Get the number of outstanding tokens the project has.\n      _totalSupply = IJBController(directory.controllerOf(_projectId)).totalOutstandingTokensOf(\n        _projectId,\n        fundingCycle.reservedRate()\n      );\n\n      // Can't redeem more tokens that is in the supply.\n      if (_tokenCount > _totalSupply) revert INSUFFICIENT_TOKENS();\n\n      if (_currentOverflow > 0)\n        // Calculate reclaim amount using the current overflow amount.\n        reclaimAmount = _reclaimableOverflowDuring(\n          _projectId,\n          fundingCycle,\n          _tokenCount,\n          _totalSupply,\n          _currentOverflow\n        );\n\n      _reclaimedTokenAmount = JBTokenAmount(_token, reclaimAmount, _decimals, _currency);\n    }\n\n    // If the funding cycle has configured a data source, use it to derive a claim amount and memo.\n    if (fundingCycle.useDataSourceForRedeem()) {\n      // Create the params that'll be sent to the data source.\n      JBRedeemParamsData memory _data = JBRedeemParamsData(\n        IJBSingleTokenPaymentTerminal(msg.sender),\n        _holder,\n        _projectId,\n        fundingCycle.configuration,\n        _tokenCount,\n        _totalSupply,\n        _currentOverflow,\n        _reclaimedTokenAmount,\n        fundingCycle.useTotalOverflowForRedemptions(),\n        fundingCycle.redemptionRate(),\n        fundingCycle.ballotRedemptionRate(),\n        _memo,\n        _metadata\n      );\n      (reclaimAmount, memo, delegate) = IJBFundingCycleDataSource(fundingCycle.dataSource())\n        .redeemParams(_data);\n    } else {\n      memo = _memo;\n    }\n  }\n\n  // The amount being reclaimed must be within the project's balance.\n  if (reclaimAmount > balanceOf[IJBSingleTokenPaymentTerminal(msg.sender)][_projectId])\n    revert INADEQUATE_PAYMENT_TERMINAL_STORE_BALANCE();\n\n  // Remove the reclaimed funds from the project's balance.\n  if (reclaimAmount > 0)\n    balanceOf[IJBSingleTokenPaymentTerminal(msg.sender)][_projectId] =\n      balanceOf[IJBSingleTokenPaymentTerminal(msg.sender)][_projectId] -\n      reclaimAmount;\n}\n"))),(0,r.kt)(l.Z,{value:"Errors",label:"Errors",mdxType:"TabItem"},(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"String"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},(0,r.kt)("inlineCode",{parentName:"strong"},"FUNDING_CYCLE_REDEEM_PAUSED"))),(0,r.kt)("td",{parentName:"tr",align:null},"Thrown if the project has configured its current funding cycle to pause redemptions.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},(0,r.kt)("inlineCode",{parentName:"strong"},"INADEQUATE_PAYMENT_TERMINAL_STORE_BALANCE"))),(0,r.kt)("td",{parentName:"tr",align:null},"Thrown if the project's balance isn't sufficient to fulfill the desired claim."))))),(0,r.kt)(l.Z,{value:"Bug bounty",label:"Bug bounty",mdxType:"TabItem"},(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Category"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"),(0,r.kt)("th",{parentName:"tr",align:null},"Reward"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"Optimization")),(0,r.kt)("td",{parentName:"tr",align:null},"Help make this operation more efficient."),(0,r.kt)("td",{parentName:"tr",align:null},"0.5ETH")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"Low severity")),(0,r.kt)("td",{parentName:"tr",align:null},"Identify a vulnerability in this operation that could lead to an inconvenience for a user of the protocol or for a protocol developer."),(0,r.kt)("td",{parentName:"tr",align:null},"1ETH")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"High severity")),(0,r.kt)("td",{parentName:"tr",align:null},"Identify a vulnerability in this operation that could lead to data corruption or loss of funds."),(0,r.kt)("td",{parentName:"tr",align:null},"5+ETH")))))))}u.isMDXComponent=!0}}]);